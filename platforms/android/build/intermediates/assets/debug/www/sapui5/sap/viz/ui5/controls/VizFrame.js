/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2015 SAP SE. All rights reserved
 */
sap.ui.define(['sap/viz/library','./libs/sap-viz-vizframe/sap-viz-vizframe','./libs/sap-viz-vizservices/sap-viz-vizservices','sap/viz/ui5/theming/Util','./ResponsiveLegend','./common/BaseControl','./common/feeds/AnalysisObject','./common/feeds/FeedItem','./common/helpers/VizControlsHelper','./common/helpers/VizFrameOptionsHelper','./common/helpers/DefaultPropertiesHelper','sap/ui/Device'],function(l,v,a,U,R,B,A,F,V,b,D,c){"use strict";var d=sap.viz.vizservices.__internal__.BindingService;var P=sap.viz.vizservices.__internal__.PropertyService;var f=B.extend("sap.viz.ui5.controls.VizFrame",{metadata:{library:"sap.viz",properties:{vizType:{type:"string",group:"Misc",defaultValue:"column"},vizProperties:{type:"object",group:"Misc",defaultValue:null},vizScales:{type:"object",group:"Misc",defaultValue:null},vizCustomizations:{type:"object",group:"Misc",defaultValue:null},legendVisible:{type:"boolean",group:"Misc",defaultValue:true}},aggregations:{dataset:{type:"sap.viz.ui5.data.Dataset",multiple:false},feeds:{type:"sap.viz.ui5.controls.common.feeds.FeedItem",multiple:true,singularName:"feed"}},events:{renderComplete:{},selectData:{},deselectData:{}}}});f.prototype.init=function(){sap.viz.ui5.controls.common.BaseControl.prototype.init.apply(this,arguments);this._wrapApi('setModel',function(){this._invalidateDataset=true;}.bind(this));this._wrapApi('setDataset',function(){this._invalidateDataset=true;}.bind(this));this._wrapApi('destroyDataset',function(){this._invalidateDataset=true;}.bind(this));this._wrapApi('addFeed',function(){this._invalidateFeeds=true;}.bind(this));this._wrapApi('removeFeed',function(){this._invalidateFeeds=true;}.bind(this));this._wrapApi('destroyFeeds',function(){this._invalidateFeeds=true;}.bind(this));this._vizFrame=null;this._currentTheme=null;this._connectPopover=null;this._clearVariables();this.data("sap-ui-fastnavgroup","true",true);};f.prototype.applySettings=function(){sap.ui.core.Control.prototype.applySettings.apply(this,arguments);};f.prototype.exit=function(){sap.viz.ui5.controls.common.BaseControl.prototype.exit.apply(this,arguments);this._clearVariables();};f.prototype._clearVariables=function(){this._clearRequestedProperties();this._cachedDataset=null;this._connectPopover=null;};f.prototype._clearRequestedProperties=function(){this.setProperty('vizProperties',null);this.setProperty('vizScales',null);this.setProperty('vizCustomizations',null);};f.prototype.getVizUid=function(){return this.getId();};f.prototype.setUiConfig=function(u){sap.viz.ui5.controls.common.BaseControl.prototype.setUiConfig.apply(this,arguments);};f.prototype.setVizType=function(s){var o=this._getCalculatedType();if(s!==this.getVizType()){this._invalidateVizType=true;}this.setProperty('vizType',s,true);if(this._vizFrame&&!this._pendingRerendering){this._switchFeeds(o,this._getCalculatedType());}else{this.invalidate();}return this;};f.prototype._switchFeeds=function(e,t){var g=F.toLightWeightFmt(this.getFeeds());var n=sap.viz.vizservices.BVRService.switchFeeds(e,g,t).feedItems;var h=V.getFeedDefsMap(t);n.forEach(function(j){if(j.id&&h[j.id]){j.type=h[j.id].type;}});var i=F.fromLightWeightFmt(n);this.vizUpdate({feeds:i});};f.prototype.invalidate=function(o){if(o instanceof sap.viz.ui5.data.Dataset){this._invalidateDataset=true;}sap.viz.ui5.controls.common.BaseControl.prototype.invalidate.call(this,o);};f.prototype.getVizProperties=function(){if(this._vizFrame){return this._mergeProperties(this._mergeProperties({},this._vizFrame.properties()||{}),this.getProperty('vizProperties')||{});}else{return this.getProperty('vizProperties');}};f.prototype.getVizScales=function(){if(this._vizFrame){return jQuery.extend(this._vizFrame.scales()||[],this.getProperty('vizScales'));}else{return this.getProperty('vizScales');}};f.prototype.zoom=function(e){if(this._vizFrame){this._vizFrame.zoom({target:"plotArea",direction:e.direction});}};f.prototype.setVizProperties=function(o){var e=sap.viz.api.serialization.migrate({'type':this._getCalculatedType(),'properties':o});if(this._vizFrame&&!this._pendingRerendering){this._vizFrame.update(e);}else{this.setProperty('vizProperties',this._mergeProperties(this.getProperty('vizProperties')||{},e.properties||{}));this.setVizScales(e.scales);this.invalidate();}return this;};f.prototype.setVizScales=function(o){if(this._vizFrame&&!this._pendingRerendering){this._vizFrame.scales(o);}else{this.setProperty('vizScales',jQuery.extend(this.getProperty('vizScales')||[],o||[]));this.invalidate();}return this;};f.prototype.getLegendVisible=function(){return this.getVizProperties().legendGroup.computedVisibility;};f.prototype.setLegendVisible=function(e){this.setVizProperties({'legend':{'visible':e},'sizeLegend':{'visible':e}});return this;};f.prototype.vizSelection=function(p,o){if(this._vizFrame){try{var r=this._vizFrame.selection.apply(this._vizFrame,arguments);if(r===this._vizFrame){r=this;}}catch(e){return null;}return r;}else{return null;}};f.prototype.vizUpdate=function(o){if(this._vizFrame){if(o.data||o.feeds){if(o.properties){this.setVizProperties(o.properties);}if(o.scales){this.setVizSacles(o.scales);}if(o.customizations){this.setVizCustomizations(o.customizations);}if(o.data){this.setDataset(o.data);}if(o.feeds){this.destroyFeeds();o.feeds.forEach(function(e){this.addFeed(e);}.bind(this));}}else{this._vizFrame.update(o);}}};f.prototype.setVizCustomizations=function(o){if(f._isCustomizationAPISupportedVizType(this._getCalculatedType())){if(this._vizFrame&&!this._pendingRerendering){this._vizFrame.customizations(o);}else{this.setProperty('vizCustomizations',this._mergeProperties(this.getProperty('vizCustomizations')||{},o||{}));}}return this;};f.prototype.getVizCustomizations=function(){if(this._vizFrame){return this._mergeProperties(this._mergeProperties({},this._vizFrame.customizations()||{}),this.getProperty('vizCustomizations')||{});}else{return this.getProperty('vizCustomizations');}};f._isCustomizationAPISupportedVizType=function(e){return jQuery.inArray(e,['info/column','info/dual_column','info/bar','info/dual_bar','info/stacked_bar','info/stacked_column','info/100_stacked_bar','info/100_stacked_column','info/100_dual_stacked_bar','info/100_dual_stacked_column','info/dual_stacked_bar','info/dual_stacked_column','info/line','info/horizontal_line','info/dual_line','info/dual_horizontal_line','info/bubble',"info/scatter",'info/combination','info/horizontal_combination','info/stacked_combination','info/horizontal_stacked_combination','info/dual_stacked_combination','info/dual_horizontal_stacked_combination'])!==-1;};f.prototype.getResponsiveLegend=function(){if(this._vizFrame){return sap.viz.ui5.controls.ResponsiveLegend.createInstance(this._vizFrame.responsiveLegend());}};f.prototype._createVizFrame=function(o){jQuery(this._app$).attr("data-sap-ui-preserve",true);var g='ui5-viz-controls';var h=jQuery(document.createElement('div'));h.addClass(g+'-viz-frame');h.appendTo(this._app$);o.container=h.get(0);this._descriptionLayer$=jQuery(document.createElement('div'));this._descriptionLayer$.addClass(g+"-viz-description");this._descriptionLayer$.appendTo(this._app$);var i=this._vizFrame=new sap.viz.vizframe.VizFrame(o,{'controls':{'morpher':{'enabled':false},},'throwError':true});i.on('selectData',function(e){this.fireEvent("selectData",e);}.bind(this));i.on('deselectData',function(e){this.fireEvent("deselectData",e);}.bind(this));i.on('initialized',function(e){this.fireEvent("renderComplete",e);}.bind(this));return i;};f.prototype._migrate=function(t,e){e.forEach(function(g){var m=sap.viz.api.serialization.feedsIdToBindingId(t,g.getUid());if(m){g.setProperty('uid',m,true);}});if(t==="info/bullet"||t==="info/vertical_bullet"){var h=false;e.forEach(function(g){h=h||g.getUid()==='actualValues'});if(!h){e.forEach(function(g){if(g.getUid()==='valueAxis'){g.setUid('actualValues');if(g.getValues().length>1){e.push(new F({'uid':'additionalValues','type':'Measure','values':g.getValues()[1]}));g.setValues(g.getValues()[0]);}}});}}};f.prototype._renderVizFrame=function(){var e=(this.getUiConfig()||{}).applicationSet;var t=this._getCalculatedType();var g=this.getFeeds();this._migrate(t,g);var h=false,i=sap.ui.getCore().getConfiguration().getTheme();if(this._currentTheme!==i){h=true;}if(!(this._invalidateFeeds||this._invalidateDataset||h)){return;}var o={'type':t};if(this._invalidateDataset){o.data=this._getVizDataset();if(this.__pendingDataRequest){return;}this._invalidateDataset=false;}if(this._invalidateFeeds){o.bindings=this._getVizBindings(t,g);this._invalidateFeeds=false;}if(this.getProperty('vizProperties')){o.properties=this.getProperty('vizProperties');}if(this.getProperty('vizScales')){o.scales=this.getProperty('vizScales');}if(this.getProperty('vizCustomizations')){o.customizations=this.getProperty('vizCustomizations');}if(!this._vizFrame||this._invalidateVizType){var j;if(e==='fiori'){j=D.getFiori(P,t);for(var k in j){if(j[k].gridline){j[k].gridline.visible=true;}}this._mergeProperties(j,b.defaultFioriProperties());}else{j=D.get(P,t);}o.properties=this._mergeProperties(j,o.properties||{});}if(this._invalidateVizType){this._invalidateVizType=false;}if(h){o.properties=this._mergeProperties(sap.viz.ui5.theming.Util.readCSSParameters(t),o.properties||{});this._currentTheme=i;}if(e==='fiori'){o.properties=o.properties||{};b.decorateFiori(o,g,!!this._vizFrame);var m=c.system.tablet||c.system.phone;if(m){if(o.properties.plotArea&&o.properties.plotArea.scrollbar){o.properties.plotArea.scrollbar.spacing=2;}if(o.properties.legend&&o.properties.legend.scrollbar){o.properties.legend.scrollbar.spacing=2;}}}if(o.properties){o.properties=P.removeInvalid(t,o.properties);}if(o.type==="info/bullet"||o.type==="info/vertical_bullet"){b.decorateBullet(o,g);}try{if(!this._vizFrame){if(o.data){this._createVizFrame(o);this._clearRequestedProperties();}}else{this._vizFrame.update(o);this._clearRequestedProperties();}if(this._connectPopover){this._connectPopover();}this._updateDescription();}catch(n){var s=(this.getUiConfig()||{}).showErrorMessage!==false;if(s){this._updateDescription(n);}this.fireEvent('renderFail',{'id':'renderFail','error':n});}};f.prototype._getVizDataset=function(){var e=this.getDataset();if(e){if(this._isExtension()){var m=sap.viz.api.metadata.Viz.get(this._getCalculatedType());if(m&&m.dataType==='raw'){return e.getRawDataset();}else{V.updateAxis(e.getDimensions(),this._getCalculatedType(),this.getFeeds());return e.getVIZCrossDataset();}}else{return e.getVIZFlatDataset();}}else{return null;}};f.prototype._getVizBindings=function(t,e){if(e&&e.length){var g=F.toLightWeightFmt(e);g=sap.viz.vizservices.BVRService.suggestFeeds(t,g,[{'id':'MND','type':'MND'}]).feedItems;if(this._isExtension()){return d.generateBindings(t,g,'CrossTableDataset');}else{return d.generateBindings(t,g,'FlatTableDataset');}}else{return null;}};f.prototype._onConnectPopover=function(e){this._connectPopover=e;};f.prototype._createChildren=function(){this._renderVizFrame();};f.prototype._updateChildren=function(){this._renderVizFrame();};f.prototype._validateSize=function(e){if(!this._app$||!this.$()||(e&&e.size&&(e.size.height==0||e.size.width==0))){return;}var g={'width':this.$().width(),'height':this.$().height()};if(this._vizFrame){var s=this._vizFrame.size();if(!s||s.width!==g.width||s.height!==g.height){this._vizFrame.size({'width':g.width,'height':g.height});}}this._updateDescriptionPosition();};f.prototype._getCalculatedType=function(){if(this._isExtension()){return this.getVizType();}else{return this._getInfoType();}};f.prototype._isExtension=function(){return C.indexOf(this._getInfoType())===-1;};f.prototype._getInfoType=function(){var e=this.getVizType();if(e.indexOf("info/")===-1){return'info/'+e;}else{return e;}};var C=['info/column','info/bar','info/stacked_bar','info/stacked_column','info/line','info/combination','info/bullet','info/bubble','info/time_bubble',"info/pie","info/donut","info/scatter","info/vertical_bullet","info/dual_stacked_bar","info/100_stacked_bar","info/100_dual_stacked_bar","info/dual_stacked_column","info/100_stacked_column","info/100_dual_stacked_column","info/stacked_combination","info/horizontal_stacked_combination","info/dual_stacked_combination","info/dual_horizontal_stacked_combination","info/dual_bar","info/dual_column","info/dual_line","info/timeseries_column","info/timeseries_line","info/timeseries_scatter","info/timeseries_bubble","info/heatmap"];f.prototype._mergeProperties=function(t,p){return P.mergeProperties(this._getCalculatedType(),t,p);};f.prototype._wrapApi=function(n,e){this[n]=function(){var r=f.prototype[n].apply(this,arguments);e();return r;}.bind(this);};f.prototype._pendingDataRequest=function(p){this.__pendingDataRequest=!!p;};f.prototype._updateDescription=function(e){if(this._descriptionLayer$){if(e){this._descriptionLayer$.show();this._descriptionLayer$.text(e);this._updateDescriptionPosition();}else{this._descriptionLayer$.hide();this._descriptionLayer$.text("");}}};f.prototype._updateDescriptionPosition=function(){var e={'width':this.$().width(),'height':this.$().height()};if(this._descriptionLayer$){this._descriptionLayer$.css({'width':e.width+"px",'height':e.height/2+50+"px",'top':e.height/2-50+"px",});}};return f;});
